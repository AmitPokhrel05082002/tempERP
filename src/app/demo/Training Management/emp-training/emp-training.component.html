<div class="job-grade-container">
  <!-- Header Section -->
  <div class="training-container">
    <div class="header">
      <div class="title">
        <h2>Programmes Management</h2>
        <p>Manage and organize training programs for your organization.</p>
      </div>
      <div class="controls" *ngIf="canEdit">
        <button class="add-btn" (click)="openAddModal()">
          <i class="ti ti-plus"></i>
          <span>Training</span>
        </button>
        <button class="add-btn">
          <i class="bi bi-download me-2"></i>
          <span>Export</span>
        </button>
      </div>
    </div>

    <!-- Search and Filter Row -->
    <div class="search-filter-row">
      <div class="d-flex justify-content-end w-100">
        <div class="search-filter-content">
          <div class="search-input-wrapper">
            <i class="bi bi-search"></i>
            <input 
              type="text" 
              placeholder="Search..."
              [(ngModel)]="searchQuery"
              (input)="applySearch()">
          </div>

          <div class="filter-container">
            <button class="filter-icon">
              <i class="bi bi-funnel"></i>
              <span>Filters</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Training List -->
    <div class="attendance-table">
      <table>
        <thead>
          <tr>
            <th>Programme Name</th>
            <th>Code</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Status</th>
            <th>Location</th>
            <th>Held By</th>
            <th>Participants</th>
            <th style="text-align: right;" *ngIf="canEdit">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let program of paginatedPrograms">
            <td style="max-width: 200px;" title="{{ program.programName }}">
              {{ program.programName }}
            </td>
            <td>{{ program.programCode || 'N/A' }}</td>
            <td>{{ program.startDate | date:'mediumDate' }}</td>
            <td>{{ program.endDate | date:'mediumDate' }}</td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(program.status)">
                {{ program.status || 'N/A' }}
              </span>
            </td>
            <td class="text-truncate" style="max-width: 150px;" title="{{ program.venue }}">
              {{ program.venue || 'N/A' }}
            </td>
            <td class="text-truncate" style="max-width: 150px;" title="{{ program.heldBy }}">
              {{ program.heldBy || 'N/A' }}
            </td>
            <td>{{ program.seatsBooked || 0 }}/{{ program.maxSeats || 0 }}</td>
            <td class="text-end" *ngIf="canEdit">
              <div class="action-buttons">
                <button class="view-btn" (click)="openViewModal(program)" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="edit-btn" (click)="openEditModal(program)" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="delete-btn" (click)="confirmDelete(program.programId)" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filteredPrograms.length === 0">
            <td [attr.colspan]="canEdit ? 9 : 8" class="text-center py-4">
              <div class="text-muted">
                <i class="bi bi-inbox display-6 d-block mb-2"></i>
                <p>No training programs found</p>
                <button class="btn btn-sm btn-outline-primary" (click)="openAddModal()" *ngIf="canEdit">
                  <i class="ti ti-plus me-1"></i> Add New Program
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="simple-pagination" *ngIf="filteredPrograms.length > 0">
      <button 
        (click)="onPageChange(currentPage - 1)" 
        [disabled]="currentPage === 1">
        <i class="bi bi-chevron-left"></i> Previous
      </button>
      
      <div class="page-info">
        Page {{ currentPage }} of {{ totalPages }}
      </div>
      
      <button 
        (click)="onPageChange(currentPage + 1)" 
        [disabled]="currentPage === totalPages">
        Next <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>
</div>

<!-- Add/Edit Training Modal -->
<ng-template #trainingModal let-modal>
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="modal-header bg-primary text-white">
      <h5 class="modal-title fw-bold">{{ isEditMode ? 'Edit' : 'Add New' }} Training Program</h5>
      <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <div class="row g-3">
        <!-- Basic Information -->
        <div class="col-12">
          <h6 class="border-bottom pb-2 mb-3">Basic Information</h6>
        </div>
        
        <div class="col-md-6">
          <label for="orgId" class="form-label">Organization *</label>
          <select 
            class="form-select" 
            id="orgId"
            formControlName="orgId"
            [class.is-invalid]="form.get('orgId')?.invalid && form.get('orgId')?.touched">
            <option value="">Select Organization</option>
            <option *ngFor="let org of organizations" [value]="org.orgId">{{ org.orgName }}</option>
          </select>
          <div *ngIf="form.get('orgId')?.invalid && form.get('orgId')?.touched" class="invalid-feedback">
            Organization is required
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="categoryId" class="form-label">Category *</label>
          <select 
            class="form-select" 
            id="categoryId"
            formControlName="categoryId"
            [class.is-invalid]="form.get('categoryId')?.invalid && form.get('categoryId')?.touched"
            [disabled]="!form.get('orgId')?.value || filteredCategories.length === 0">
            <option value="">Select Category</option>
            <option *ngFor="let category of filteredCategories" [value]="category.categoryId">
              {{ category.categoryName }}
            </option>
          </select>
          <div *ngIf="!form.get('orgId')?.value" class="form-text text-muted">
            Please select an organization first
          </div>
          <div *ngIf="form.get('orgId')?.value && filteredCategories.length === 0" class="form-text text-muted">
            No categories found for this organization
          </div>
          <div *ngIf="form.get('categoryId')?.invalid && form.get('categoryId')?.touched" class="invalid-feedback">
            Category is required
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="programName" class="form-label">Program Name *</label>
          <input 
            type="text" 
            class="form-control" 
            id="programName"
            formControlName="programName"
            [class.is-invalid]="form.get('programName')?.invalid && form.get('programName')?.touched">
          <div *ngIf="form.get('programName')?.invalid && form.get('programName')?.touched" class="invalid-feedback">
            Program name is required
          </div>
        </div>
            
        <div class="col-md-6">
          <label for="programType" class="form-label">Program Type *</label>
          <select 
            class="form-select" 
            id="programType"
            formControlName="programType"
            [class.is-invalid]="form.get('programType')?.invalid && form.get('programType')?.touched">
            <option value="In-House">In-House</option>
            <option value="External">External</option>
            <option value="Workshop">Workshop</option>
            <option value="Seminar">Seminar</option>
            <option value="Conference">Conference</option>
          </select>
        </div>
        
        <div class="col-md-6">
          <label for="deliveryMethod" class="form-label">Delivery Method *</label>
          <select 
            class="form-select" 
            id="deliveryMethod"
            formControlName="deliveryMethod"
            [class.is-invalid]="form.get('deliveryMethod')?.invalid && form.get('deliveryMethod')?.touched">
            <option value="In-Person">In-Person</option>
            <option value="Virtual">Virtual</option>
            <option value="Hybrid">Hybrid</option>
            <option value="E-Learning">E-Learning</option>
          </select>
        </div>
        
        <!-- Dates Section -->
        <div class="col-12 mt-4">
          <h6 class="border-bottom pb-2 mb-3">Schedule</h6>
        </div>
        
        <div class="col-md-6">
          <label for="startDate" class="form-label">Start Date *</label>
          <input 
            type="date" 
            class="form-control" 
            id="startDate"
            formControlName="startDate"
            [class.is-invalid]="form.get('startDate')?.invalid && form.get('startDate')?.touched">
          <div *ngIf="form.get('startDate')?.invalid && form.get('startDate')?.touched" class="invalid-feedback">
            Start date is required
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="endDate" class="form-label">End Date *</label>
          <input 
            type="date" 
            class="form-control" 
            id="endDate"
            formControlName="endDate"
            [class.is-invalid]="form.get('endDate')?.invalid && form.get('endDate')?.touched">
          <div *ngIf="form.get('endDate')?.invalid && form.get('endDate')?.touched" class="invalid-feedback">
            End date is required and must be after start date
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="durationHours" class="form-label">Duration (Hours) *</label>
          <input 
            type="number" 
            class="form-control" 
            id="durationHours"
            min="1"
            formControlName="durationHours"
            [class.is-invalid]="form.get('durationHours')?.invalid && form.get('durationHours')?.touched">
          <div *ngIf="form.get('durationHours')?.invalid && form.get('durationHours')?.touched" class="invalid-feedback">
            Please enter a valid duration in hours
          </div>
        </div>
        
        <!-- Details Section -->
        <div class="col-12 mt-4">
          <h6 class="border-bottom pb-2 mb-3">Details</h6>
        </div>
        
        <div class="col-md-6">
          <label for="costPerParticipant" class="form-label">Cost Per Participant *</label>
          <div class="input-group">
            <input 
              type="number" 
              class="form-control" 
              id="costPerParticipant"
              min="0"
              step="0.01"
              formControlName="costPerParticipant"
              [class.is-invalid]="form.get('costPerParticipant')?.invalid && form.get('costPerParticipant')?.touched">
          </div>
          <div *ngIf="form.get('costPerParticipant')?.invalid && form.get('costPerParticipant')?.touched" class="invalid-feedback d-block">
            Please enter a valid cost amount
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="batchName" class="form-label">Batch Name</label>
          <input 
            type="text" 
            class="form-control" 
            id="batchName"
            formControlName="batchName">
        </div>
        
        <div class="col-md-6">
          <label for="heldBy" class="form-label">Conducted By *</label>
          <input 
            type="text" 
            class="form-control" 
            id="heldBy"
            formControlName="heldBy"
            [class.is-invalid]="form.get('heldBy')?.invalid && form.get('heldBy')?.touched">
          <div *ngIf="form.get('heldBy')?.invalid && form.get('heldBy')?.touched" class="invalid-feedback">
            This field is required
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="venue" class="form-label">Venue *</label>
          <input 
            type="text" 
            class="form-control" 
            id="venue"
            formControlName="venue"
            [class.is-invalid]="form.get('venue')?.invalid && form.get('venue')?.touched">
          <div *ngIf="form.get('venue')?.invalid && form.get('venue')?.touched" class="invalid-feedback">
            Venue is required
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="maxSeats" class="form-label">Maximum Seats *</label>
          <input 
            type="number" 
            class="form-control" 
            id="maxSeats"
            min="1"
            formControlName="maxSeats"
            [class.is-invalid]="form.get('maxSeats')?.invalid && form.get('maxSeats')?.touched">
          <div *ngIf="form.get('maxSeats')?.invalid && form.get('maxSeats')?.touched" class="invalid-feedback">
            Please enter a valid number of seats
          </div>
        </div>
        
        <div class="col-md-6">
          <label for="isActive" class="form-label">Status *</label>
          <select 
            class="form-select" 
            id="isActive"
            formControlName="isActive">
            <option [ngValue]="true">Active</option>
            <option [ngValue]="false">Inactive</option>
          </select>
        </div>
        
        <div class="col-12">
          <label for="description" class="form-label">Description</label>
          <textarea 
            class="form-control" 
            id="description" 
            rows="3"
            formControlName="description"
            placeholder="Enter program description..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss()">Cancel</button>
      <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
        {{ isEditMode ? 'Update' : 'Save' }}
      </button>
    </div>
  </form>
</ng-template>

<!-- View Training Modal -->
<ng-template #viewTrainingModal let-modal>
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title fw-bold">Training Program Details</h5>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()" aria-label="Close"></button>
  </div>
  <div class="modal-body">
    <div class="row">
      <div class="col-md-12">
        <h5>{{ currentTraining?.programName || 'N/A' }} <span *ngIf="currentTraining?.programCode">({{ currentTraining.programCode }})</span></h5>
        <p class="text-muted" *ngIf="currentTraining?.programDescription">{{ currentTraining.programDescription }}</p>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-6">
        <h6>Details</h6>
        <p class="mb-2">
          <strong>Status:</strong>
          <span class="badge ms-2" [ngClass]="getStatusBadgeClass(currentTraining?.status)">
            {{currentTraining?.status || 'N/A'}}
          </span>
        </p>
        <p class="mb-2"><strong>Trainer:</strong> {{currentTraining?.trainerName || 'N/A'}}</p>
        <p class="mb-2"><strong>Location:</strong> {{currentTraining?.location || 'N/A'}}</p>
        <p class="mb-2"><strong>Venue:</strong> {{currentTraining?.venue || 'N/A'}}</p>
      </div>
      
      <div class="col-md-6">
        <h6>Schedule</h6>
        <p class="mb-2"><strong>Start Date:</strong> {{currentTraining?.startDate | date:'mediumDate'}}</p>
        <p class="mb-2"><strong>End Date:</strong> {{currentTraining?.endDate | date:'mediumDate'}}</p>
        <p class="mb-2"><strong>Max Seats:</strong> {{currentTraining?.maxSeats || 0}}</p>
        <div class="mb-2">
          <strong>Seats Booked: </strong>
          {{currentTraining?.seatsBooked || 0}}/{{currentTraining?.maxSeats || 0}}
          <div class="progress mt-1" style="height: 5px;">
            <div class="progress-bar bg-success" 
                 role="progressbar" 
                 [style.width]="getProgressPercentage(currentTraining) + '%'"
                 [attr.aria-valuenow]="currentTraining?.seatsBooked || 0" 
                 [attr.aria-valuemin]="0" 
                 [attr.aria-valuemax]="currentTraining?.maxSeats || 1">
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="mt-4" *ngIf="currentTraining?.nominations?.length">
      <h6>Nominations ({{currentTraining.nominations.length}})</h6>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Employee</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let nom of currentTraining.nominations">
              <td>{{nom.employeeName || nom.employeeId || 'N/A'}}</td>
              <td>
                <span class="badge" [ngClass]="getStatusBadgeClass(nom.status)">
                  {{nom.status || 'N/A'}}
                </span>
              </td>
              <td>{{(nom.nominationDate || nom.createdDate) ? ((nom.nominationDate || nom.createdDate) | date:'mediumDate') : 'N/A'}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
  </div>
</ng-template>