<div class="container" #exportDiv>
  <div class="header">
    <div class="header-top">
      <div class="title-block">
        <h1>Employee Leave Request Management</h1>
        <p>Track and manage employee leave requests</p>
      </div>
      <div class="date-export">
        <div class="date-picker-container">
          <button class="date-picker" (click)="toggleDatePicker()">
            <i class="fa fa-calendar"></i>
            <span>{{ formatDisplayDate(selectedDate) }}</span>
          </button>
          <button class="clear-date" *ngIf="selectedDate" (click)="clearSelectedDate()">
            <i class="fas fa-times"></i>
          </button>
          <input #dateInput type="date" [style.display]="showDatePicker ? 'block' : 'none'"
            (change)="onDateChange($event)" (click)="$event.stopPropagation()" />
          <button class="request-leave-btn" (click)="openRequestModal()">
            <i class="fas fa-plus"></i> Request Leave
          </button>
        </div>

        <!-- Request Leave Modal -->
        <div class="modal" *ngIf="showRequestModal" (click)="closeModal($event)">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Request Leave</h3>
              <button class="close-btn" (click)="closeModal($event)">&times;</button>
            </div>
            <div class="modal-body">
              <p>Choose an option to proceed with your leave request:</p>
              <div class="modal-buttons">
                <button class="modal-btn qr-btn" (click)="generateQR()">
                  <i class="fas fa-qrcode"></i> Generate QR
                </button>
                <button class="modal-btn form-btn" (click)="openLeaveForm()">
                  <i class="fas fa-file-alt"></i> Fill Form
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Leave Form Modal -->
        <div class="modal" *ngIf="showLeaveForm" (click)="closeLeaveForm()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <app-leave-form (close)="closeLeaveForm()" (submitted)="onLeaveSubmitted($event)">
            </app-leave-form>
          </div>
        </div>

        <!-- QR Code Modal -->
        <div class="modal" *ngIf="showQRCodeModal" (click)="closeQRCodeModal()">
          <div class="modal-content qr-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Your Leave Request QR Code</h3>
              <button class="close-btn" (click)="closeQRCodeModal()">&times;</button>
            </div>
            <div class="modal-body qr-body">
              <div class="qr-placeholder">
                <qrcode [qrdata]="qrData" [width]="256" [errorCorrectionLevel]="'M'"></qrcode>
                <p>Scan this QR code to view leave request details</p>
              </div>
            </div>
          </div>
        </div>

        <button class="export-button" (click)="exportToPDF()">
          <i class="bi bi-upload"></i> Export
        </button>
      </div>
    </div>

    <div class="header-divider"></div>

    <!-- Updated Filter Section -->
    <div class="filter-container d-flex flex-wrap align-items-stretch gap-2 mb-4" *ngIf="canSeeDepartmentControls() && !isCurrentUserEmployee()">
      <!-- Department Select -->
      <div class="filter-item">
        <select class="form-select form-select-sm h-100" [(ngModel)]="selectedDepartment" (change)="onDepartmentChange()">
          <option value="All Departments">All Departments</option>
          <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
        </select>
      </div>

      <!-- Search Input -->
      <div class="search-container ms-md-auto" *ngIf="canSeeDepartmentControls() && !isCurrentUserEmployee()">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control form-control-sm border-start-0" 
                 placeholder="Search by name or id..." 
                 [(ngModel)]="searchTerm" 
                 (input)="onSearchInput($event)">
          <button class="btn btn-outline-secondary btn-sm" type="button" *ngIf="searchTerm" (click)="searchTerm = ''; onSearchInput($event)">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>

      <!-- Filter Button -->
      <div class="filter-item position-relative">
        <button class="btn btn-outline-dark btn-sm d-flex align-items-center h-100" (click)="toggleFilters()">
          <i class="bi bi-funnel me-2"></i>
          Filters
          <span class="badge bg-primary ms-2" *ngIf="filterCount > 0">{{ filterCount }}</span>
        </button>

        <!-- Filter Dropdown -->
        <div class="card shadow-sm position-absolute top-100 end-0 mt-1" *ngIf="showFilters" style="z-index: 1050; width: 280px;" (click)="$event.stopPropagation()">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold mb-0">Filters</h6>
              <button type="button" class="btn-close" (click)="showFilters = false" aria-label="Close"></button>
            </div>

            <div class="mb-3">
              <h6 class="fw-bold mb-2">Status</h6>
              <div class="d-flex flex-wrap gap-2">
                <button *ngFor="let status of statuses" class="btn btn-sm"
                  [class.btn-primary]="selectedStatus === status"
                  [class.btn-outline-primary]="selectedStatus !== status" 
                  (click)="setStatusFilter(status)">
                  {{ status }}
                </button>
              </div>
            </div>

            <div class="mb-3">
              <h6 class="fw-bold mb-2">Date Range</h6>
              <div class="d-flex flex-column gap-2">
                <input type="date" class="form-control form-control-sm" [(ngModel)]="filterStartDate">
                <input type="date" class="form-control form-control-sm" [(ngModel)]="filterEndDate">
              </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <button class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">
                Clear
              </button>
              <button class="btn btn-sm btn-primary" (click)="applyFiltersAndClose()">
                Apply
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Summary -->
    <div class="filter-summary mb-3" *ngIf="hasAppliedFilters()">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="text-muted small">Applied filters:</span>

        <span class="badge bg-info" *ngIf="selectedDepartment !== 'All Departments'">
          <span>Department: {{ selectedDepartment }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="selectedDepartment = 'All Departments'; onDepartmentChange()"></i>
        </span>

        <span class="badge bg-warning" *ngIf="selectedStatus !== 'All'">
          <span>Status: {{ selectedStatus }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="setStatusFilter('All')"></i>
        </span>

        <span class="badge bg-secondary" *ngIf="searchTerm.trim() !== ''">
          <span>Search: {{ searchTerm }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="searchTerm = ''; onSearchInput($event)"></i>
        </span>

        <button class="btn btn-outline-danger btn-sm ms-2" (click)="clearAllFilters()">
          Clear All
        </button>
      </div>
    </div>
  </div>

  <div class="leave-sections">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <p>Loading leave requests...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage" class="error-container">
      <p>{{ errorMessage }}</p>
      <button class="retry-btn" (click)="loadLeaveRequests()">Retry</button>
    </div>

    <!-- Content -->
    <ng-container *ngIf="!isLoading && !errorMessage">
      <div class="leave-section" *ngIf="!selectedDate && !isCurrentUserEmployee()">
        <h3 class="section-title">Today's Leave Requests</h3>
        <div class="leave-cards">
          <!-- Header row -->
          <div class="leave-card header-row">
            <div class="employee-code">Employee ID</div>
            <div class="employee-details">Name</div>
            <div class="leave-dates">Date Requested</div>
            <div class="leave-duration">Days</div>
            <div class="status-actions">Status</div>
            <div class="leave-reason">Reason</div>
            <div class="view-btn">Action</div>
          </div>

          <div class="leave-card" *ngFor="let leave of filteredTodaysLeaves">
            <div class="employee-code">{{ leave.empCode }}</div>
            <div class="employee-details">
              <strong>{{ leave.name }}</strong>
              <span>{{ leave.department }}</span>
            </div>
            <div class="leave-dates">{{ leave.date }}</div>
            <div class="leave-duration">{{ leave.duration }}</div>

            <!-- Role-based Status Display -->
            <div class="status-actions">
              <ng-container *ngIf="canManageLeaves()">
                <ng-container *ngIf="leave.status?.toLowerCase() === 'pending'; else adminStatusDisplay">
                  <button class="approve" (click)="$event.stopPropagation(); updateStatus(leave, 'Approved')"
                    title="Approve Leave">
                    <i class="fas fa-check"></i> Approve
                  </button>
                  <button class="reject" (click)="$event.stopPropagation(); updateStatus(leave, 'Rejected')"
                    title="Reject Leave">
                    <i class="fas fa-times"></i> Reject
                  </button>
                </ng-container>
                <ng-template #adminStatusDisplay>
                  <div class="leave-status">
                    <span [class]="'status-label ' + leave.status.toLowerCase()">
                      {{ leave.status }}
                    </span>
                  </div>
                </ng-template>
              </ng-container>

              <ng-container *ngIf="!canManageLeaves()">
                <div class="leave-status">
                  <span [class]="'status-label ' + leave.status.toLowerCase()">
                    {{ leave.status }}
                  </span>
                </div>
              </ng-container>
            </div>

            <div class="leave-reason" title="{{ leave.reason }}">
              {{ leave.reason | slice:0:20 }}{{ leave.reason?.length > 20 ? '...' : '' }}
            </div>
            <button class="view-btn" [routerLink]="['/balanceleave', leave.empId]" (click)="$event.stopPropagation()">
              <i class="fas fa-eye"></i> View
            </button>
          </div>
          
          <div class="no-leaves" *ngIf="filteredTodaysLeaves.length === 0">
            {{ searchTerm || selectedDepartment !== 'All Departments' ? 'No matching leave requests for today' : 'No leave requests for today' }}
          </div>
        </div>
      </div>

      <div class="leave-section" [class.highlight-section]="selectedDate">
        <h3 class="section-title">
          {{ selectedDate ? ('Leave Requests for ' + formatDisplayDate(selectedDate)) : 
             (isCurrentUserEmployee() ? 'My Leave Requests' : 'All Leave Requests') }}
        </h3>
        <div class="leave-cards">
          <!-- Header row -->
          <div class="leave-card header-row">
            <div class="employee-code">Employee ID</div>
            <div class="employee-details">Name</div>
            <div class="leave-dates">Date Requested</div>
            <div class="leave-duration">Days</div>
            <div class="status-actions">Status</div>
            <div class="leave-reason">Reason</div>
            <div class="view-btn">Action</div>
          </div>

          <div class="leave-card" *ngFor="let leave of filteredLeaves">
            <div class="employee-code">{{ leave.empCode }}</div>
            <div class="employee-details">
              <strong>{{ leave.name }}</strong>
              <span>{{ leave.department }}</span>
            </div>
            <div class="leave-dates">{{ leave.date }}</div>
            <div class="leave-duration">{{ leave.duration }}</div>

            <!-- Role-based Status Display -->
            <div class="status-actions">
              <ng-container *ngIf="canManageLeaves()">
                <ng-container *ngIf="leave.status?.toLowerCase() === 'pending'; else adminStatusDisplay">
                  <button class="approve" (click)="$event.stopPropagation(); updateStatus(leave, 'Approved')"
                    title="Approve Leave">
                    <i class="fas fa-check"></i> Approve
                  </button>
                  <button class="reject" (click)="$event.stopPropagation(); updateStatus(leave, 'Rejected')"
                    title="Reject Leave">
                    <i class="fas fa-times"></i> Reject
                  </button>
                </ng-container>
                <ng-template #adminStatusDisplay>
                  <div class="leave-status">
                    <span [class]="'status-label ' + leave.status.toLowerCase()">
                      {{ leave.status }}
                    </span>
                  </div>
                </ng-template>
              </ng-container>

              <ng-container *ngIf="!canManageLeaves()">
                <div class="leave-status">
                  <span [class]="'status-label ' + leave.status.toLowerCase()">
                    {{ leave.status }}
                  </span>
                </div>
              </ng-container>
            </div>

            <div class="leave-reason" title="{{ leave.reason }}">
              {{ leave.reason | slice:0:20 }}{{ leave.reason?.length > 20 ? '...' : '' }}
            </div>
            <button class="view-btn" [routerLink]="['/balanceleave', leave.empId]" (click)="$event.stopPropagation()">
              <i class="fas fa-eye"></i> View
            </button>
          </div>
          
          <div class="no-leaves" *ngIf="filteredLeaves.length === 0">
            {{ searchTerm || selectedDepartment !== 'All Departments' || selectedDate ? 'No leave requests match your criteria' : 'No leave requests found' }}
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>