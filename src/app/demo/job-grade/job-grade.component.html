
<div class="job-grade-container">
  <div class="header">
    <div class="title">
      <h2>Job Grades</h2>
      <p>Manage and organize job grades for your organization.</p>
    </div>
    <div class="controls">
      <!-- Export button removed as per user request -->
    </div>
  </div>

  <div class="filter-row-container">
    <!-- Search and Filters -->
    <div class="search-filter-row">
      <div class="search-input-wrapper">
        <i class="ti ti-search"></i>
        <input type="text" placeholder="Search grades..." 
               (input)="onSearchInput($event)" [value]="searchQuery" />
      </div>
      
      <div class="filter-container">
        <button class="filter-icon" (click)="toggleFilter()" [class.active]="isFilterActive()">
          <i class="ti ti-filter-2"></i>
          <span>Filters</span>
          <span class="filter-count" *ngIf="isFilterActive()">
            {{ (filterOptions.selectedGrades.size + filterOptions.selectedPositionNames.size) || '' }}
          </span>
        </button>
        
        <div class="filter-dropdown" *ngIf="isFilterOpen">
          <div class="filter-section">
            <h4>Grade Name</h4>
            <div class="filter-options">
              <div class="filter-options-scroll">
                <div *ngFor="let name of (setToArray(filterOptions.positionNames) | slice:0:showAllPositionNames ? undefined : 5)">
                  <label class="filter-option">
                    <input type="checkbox" 
                           [checked]="isSelected(filterOptions.selectedPositionNames, name)"
                           (change)="toggleFilterOption('positionNames', name)">
                    <span>{{ name }}</span>
                  </label>
                </div>
              </div>
              <div *ngIf="filterOptions.positionNames.size > 5" class="text-end mt-2">
                <button class="show-more-btn" (click)="toggleShowAll('positionNames')">
                  {{ showAllPositionNames ? 'Show less' : 'Show more...' }}
                </button>
              </div>
            </div>
          </div>
          
          <div class="filter-section">
            <h4>Grade Code</h4>
            <div class="filter-options">
              <div class="filter-options-scroll">
                <div *ngFor="let grade of (setToArray(filterOptions.grades) | slice:0:showAllGrades ? undefined : 5)">
                  <label class="filter-option">
                    <input type="checkbox" 
                           [checked]="isSelected(filterOptions.selectedGrades, grade)"
                           (change)="toggleFilterOption('grades', grade)">
                    <span>{{ grade }}</span>
                  </label>
                </div>
              </div>
              <div *ngIf="filterOptions.grades.size > 5" class="text-end mt-2">
                <button class="show-more-btn" (click)="toggleShowAll('grades')">
                  {{ showAllGrades ? 'Show less' : 'Show more...' }}
                </button>
              </div>
            </div>
          </div>
          
          <div class="filter-actions">
            <button class="clear-btn" (click)="clearFilters()">
              Clear All
            </button>
            <button class="apply-btn" (click)="isFilterOpen = false">
              Apply
            </button>
          </div>
        </div>
      </div>
      
      <button class="add-grade-btn" (click)="openModal()">
        <i class="ti ti-plus"></i>
        <span>Add Grade</span>
      </button>
    </div>
  </div>

  <!-- Grades Table -->
  <div class="attendance-table" *ngIf="!isLoading && filteredGrades.length > 0">
    <table>
      <thead>
        <tr>
          <th>Grade Name</th>
          <th>Grade Code</th>
          <th>Min Salary</th>
          <th>Max Salary</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let grade of paginatedGrades">
          <td>{{ grade.gradeName || '--' }}</td>
          <td>{{ grade.gradeCode || '--' }}</td>
          <td>{{ (grade.minSalary | currency:'Nu. ':'symbol':'1.0-0') || '--' }}</td>
          <td>{{ (grade.maxSalary | currency:'Nu. ':'symbol':'1.0-0') || '--' }}</td>
          <td>
            <div class="action-buttons">
              <button class="view-btn" (click)="viewGrade(grade)" title="View">
                <i class="ti ti-eye"></i>
              </button>
              <button class="edit-btn" (click)="openModal(grade)" title="Edit">
                <i class="ti ti-edit"></i>
              </button>
              <button class="delete-btn" (click)="deleteGrade(grade.gradeId)" title="Delete">
                <i class="ti ti-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredGrades.length === 0 && !errorMessage" class="text-center py-5">
    <div class="text-muted">
      <i class="bi bi-inbox display-4 d-block mb-3"></i>
      <p class="mb-2">No grades found.</p>
      <button class="btn btn-primary btn-sm" (click)="openModal()">
        Add new grade
      </button>
    </div>
  </div>

  <!-- Pagination -->
  <div class="simple-pagination" *ngIf="filteredGrades.length > itemsPerPage && !isLoading">
    <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
      <i class="ti ti-chevron-left"></i> Previous
    </button>
    <span class="page-info">
      Page {{ currentPage }} of {{ totalPages }}
    </span>
    <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
      Next <i class="ti ti-chevron-right"></i>
    </button>
  </div>

    <!-- Add/Edit Modal -->
    <div class="emp-att-modal modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="emp-att-modal-content modal-content border-0 shadow">
                <div class="emp-att-modal-header modal-header bg-warning text-white border-0">
                    <h5 class="modal-title fw-bold">
                        {{ isEditMode ? 'Edit' : 'Add' }} Job Grade
                    </h5>
                    <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
                </div>

                <div class="emp-att-modal-body modal-body p-4">
                    <form [formGroup]="form" (ngSubmit)="saveGrade()">
                        <!-- Row 1 -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="emp-att-form-label form-label fw-medium">Organization</label>
                                <select formControlName="orgId" class="form-control" 
                                    (change)="onOrganizationSelect(form.get('orgId')?.value)">
                                    <option value="">Select Organization</option>
                                    <option *ngFor="let org of organizations" [value]="org.orgId">
                                        {{ org.orgName }}
                                    </option>
                                </select>
                                <div *ngIf="form.get('orgId')?.invalid && form.get('orgId')?.touched"
                                    class="emp-att-form-error text-danger small mt-1">
                                    Organization is required
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="emp-att-form-label form-label fw-medium">Grade Name</label>
                                <input type="text" class="form-control" formControlName="gradeName"
                                    placeholder="Enter grade name">
                                <div *ngIf="form.get('gradeName')?.invalid && form.get('gradeName')?.touched"
                                    class="emp-att-form-error text-danger small mt-1">
                                    Grade name is required
                                </div>
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="emp-att-form-label form-label fw-medium">Grade Code</label>
                                <input type="text" class="form-control" formControlName="gradeCode"
                                    placeholder="Enter grade code">
                                <div *ngIf="form.get('gradeCode')?.invalid && form.get('gradeCode')?.touched"
                                    class="emp-att-form-error text-danger small mt-1">
                                    Grade code is required
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="emp-att-form-label form-label fw-medium">Min Salary</label>
                                <input type="number" class="form-control" formControlName="minSalary"
                                    placeholder="Enter min salary">
                                <div *ngIf="form.get('minSalary')?.invalid && form.get('minSalary')?.touched"
                                    class="emp-att-form-error text-danger small mt-1">
                                    Min salary is required and must be a positive number
                                </div>
                            </div>
                        </div>

                        <!-- Row 3 -->
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="emp-att-form-label form-label fw-medium">Max Salary</label>
                                <input type="number" class="form-control" formControlName="maxSalary"
                                    placeholder="Enter max salary">
                                <div *ngIf="form.get('maxSalary')?.invalid && form.get('maxSalary')?.touched"
                                    class="emp-att-form-error text-danger small mt-1">
                                    Max salary is required and must be a positive number
                                </div>
                            </div>
                        </div>

                        <!-- Salary Components Section -->
                        <div class="mb-4">
                            <h6 class="mb-3">Salary Components</h6>
                            
                            <!-- List of added components -->
                            <div *ngFor="let component of salaryComponentsArray.controls; let i = index" class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">{{ component.get('componentName')?.value }}</h6>
                                        <button type="button" class="btn-close" (click)="removeSalaryComponent(i)" aria-label="Remove"></button>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Amount</label>
                                            <input type="number" class="form-control" 
                                                [formControl]="getFormControl(component, 'componentValue')" 
                                                min="0">
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- Add Component Button -->
                            <button type="button" class="btn btn-outline-primary btn-sm" (click)="showSalaryComponentForm = !showSalaryComponentForm" *ngIf="!showSalaryComponentForm">
                                <i class="bi bi-plus-lg me-1"></i> Add Salary Component
                            </button>

                            <!-- Add Component Form -->
                            <div class="card mt-3" *ngIf="showSalaryComponentForm">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">Add Salary Component</h6>
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <select class="form-select" [(ngModel)]="selectedComponentId" [ngModelOptions]="{standalone: true}">
                                                <option value="">Select a component</option>
                                                <option *ngFor="let comp of availableSalaryComponents" [value]="comp.id" [disabled]="isComponentSelected(comp.id)">
                                                    {{ comp.name }} ({{ comp.type }})
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 d-flex gap-2">
                                            <button type="button" class="btn btn-primary btn-sm" (click)="addSalaryComponent()" [disabled]="!selectedComponentId">
                                                Add
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="showSalaryComponentForm = false">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Salary Range Validation -->
                        <div *ngIf="form.hasError('invalidSalaryRange')" class="alert alert-danger">
                            Max salary must be greater than min salary
                        </div>
                    </form>
                </div>

                <div class="emp-att-modal-footer modal-footer border-0 p-4 pt-0">
                    <button type="button" class="emp-att-cancel-btn btn btn-outline-dark" (click)="closeModal()">
                        Cancel
                    </button>
                    <button type="button" class="emp-att-save-btn btn btn-warning"
                        [disabled]="form.invalid || form.hasError('invalidSalaryRange')" (click)="saveGrade()">
                        {{ isEditMode ? 'Update' : 'Save' }} Grade
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="emp-att-modal-backdrop modal-backdrop fade" [class.show]="showModal"
        [style.display]="showModal ? 'block' : 'none'" (click)="closeModal()">
    </div>

    <!-- View Grade Modal -->
    <div class="emp-att-modal modal fade" [class.show]="showViewModal" [style.display]="showViewModal ? 'block' : 'none'">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="emp-att-modal-content modal-content border-0 shadow">
                <div class="emp-att-modal-header modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-info-circle me-2"></i>Grade Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" (click)="closeModal()" aria-label="Close"></button>
                </div>
                
                <div class="emp-att-modal-body modal-body p-4" *ngIf="viewGradeData">
                    <!-- Grade Details -->
                    <div class="mb-4">
                        <h6 class="mb-3">Grade Information</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-medium">Grade Name</label>
                                    <div class="form-control-plaintext">{{ viewGradeData.gradeName || 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-medium">Grade Code</label>
                                    <div class="form-control-plaintext">{{ viewGradeData.gradeCode || 'N/A' }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-medium">Min Salary</label>
                                    <div class="form-control-plaintext">{{ viewGradeData.minSalary | currency:'Nu. ':'symbol':'1.0-0' }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-medium">Max Salary</label>
                                    <div class="form-control-plaintext">{{ viewGradeData.maxSalary | currency:'Nu. ':'symbol':'1.0-0' }}</div>
                                </div>
                            </div>
                            <div class="col-12" *ngIf="viewGradeData.progressionRules">
                                <div class="form-group">
                                    <label class="form-label fw-medium">Progression Rules</label>
                                    <div class="form-control-plaintext">{{ viewGradeData.progressionRules }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Salary Structure -->
                    <div class="mb-4" *ngIf="viewGradeData.salaryStructures && viewGradeData.salaryStructures.length > 0">
                        <h6 class="mb-3">Salary Components</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Component</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let component of viewGradeData.salaryStructures">
                                        <td>{{ component.componentName || 'N/A' }}</td>
                                        <td>{{ component.componentValue | currency:'Nu. ':'symbol':'1.0-0' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="alert alert-info" *ngIf="!viewGradeData.salaryStructures || viewGradeData.salaryStructures.length === 0">
                        No salary components found for this grade.
                    </div>
                </div>

                <div class="emp-att-modal-footer modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-secondary" (click)="closeModal()">
                        <i class="bi bi-x-lg me-1"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="emp-att-modal-backdrop modal-backdrop fade" [class.show]="showViewModal" 
        [style.display]="showViewModal ? 'block' : 'none'" (click)="closeModal()">
    </div>
</div>