<div class="card">
  <div class="card-body">
    <!-- Debug information (visible only in development) -->
    <!-- <div *ngIf="!environment.production" class="alert alert-info mb-3">
      <h5>Debug Information</h5>
      <div class="row">
        <div class="col-md-4">
          <p><strong>Data Status:</strong></p>
          <p>Raw Data: {{ attendanceData?.length || 0 }} records</p>
          <p>Filtered: {{ filteredAttendance?.length || 0 }} records</p>
          <p>Showing: {{ paginatedData?.length || 0 }} records</p>
        </div>
        <div class="col-md-4">
          <p><strong>Pagination:</strong></p>
          <p>Page {{ currentPage }} of {{ totalPages }}</p>
          <p>{{ itemsPerPage }} items per page</p>
        </div>
        <div class="col-md-4">
          <button class="btn btn-sm btn-warning me-2" (click)="debugComponentState()">Debug State</button>
          <button class="btn btn-sm btn-warning" (click)="debugRefreshTable()">Refresh Table</button>
        </div>
      </div>
    </div> -->

    <!-- 1. UPDATED HEADER SECTION -->
    <div class="att-det-header d-flex justify-content-between align-items-start mb-4">
      <div>
        <h2 class="att-det-title">
          {{ currentUserRole === 'EMPLOYEE' ? 'My Attendance' : 
             (isManager && managerDepartmentName) ? managerDepartmentName + ' Department Attendance' : 
             'Employee Attendance' }}
        </h2>
        <p class="att-det-subtitle text-muted mb-0">
          {{ currentUserRole === 'EMPLOYEE' ?
          'Track your attendance records and work hours.' : 
          isManager ? 'Track attendance records for employees in your department.' :
          'Keep track of employee attendance on a daily basis.' }}
        </p>

        <!-- Manager access warning -->
        <div class="alert alert-warning alert-sm mt-2" *ngIf="isManager && !managerDepartmentId">
          <i class="bi bi-exclamation-triangle me-1"></i>
          Access restricted: No department assigned to your manager account.
        </div>

        <!-- Manager access confirmation -->
        <div class="alert alert-info alert-sm mt-2" *ngIf="isManager && managerDepartmentId">
          <i class="bi bi-check-circle me-1"></i>
          Department access confirmed: {{ managerDepartmentName || 'Loading department...' }}
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="att-det-actions d-flex gap-2 align-items-start">
        <button *ngIf="canExport" class="att-det-export-btn btn btn-warning d-flex align-items-center"
          (click)="exportToPdf()">
          <i class="bi bi-download me-2"></i>
          Export
        </button>
      </div>
    </div>

    <!-- 2. UPDATED FILTER CONTAINER -->
    <div class="filter-container d-flex flex-wrap align-items-stretch gap-2 mb-4">
      <!-- Employee Name Display -->
      <div class="filter-item" *ngIf="currentUserRole === 'EMPLOYEE' && currentUserName">
        <div class="employee-name-display form-control form-control-sm h-100 d-flex align-items-center bg-light">
          <i class="bi bi-person-circle me-2 text-primary"></i>
          <span class="fw-medium text-dark">{{ currentUserName }}</span>
        </div>
      </div>

      <!-- Manager Department Display -->
      <div class="filter-item" *ngIf="isManager && managerDepartmentId">
        <div class="manager-dept-display form-control form-control-sm h-100 d-flex align-items-center bg-success bg-opacity-10">
          <i class="bi bi-building me-2 text-success"></i>
          <span class="fw-medium text-dark">{{ managerDepartmentName || 'Loading...' }}</span>
          <small class="text-muted ms-2">(Your Department)</small>
        </div>
      </div>

      <!-- Branch Select -->
      <div class="filter-item" *ngIf="canViewAllBranches && !isManager">
        <select class="form-select form-select-sm h-100" [(ngModel)]="selectedBranchId" (change)="onBranchChange($event)">
          <option value="">All Branches</option>
          <option *ngFor="let branch of branches" [value]="branch.branchId">
            {{ branch.branchName }}
          </option>
        </select>
      </div>

      <!-- Department Select -->
      <div class="filter-item" *ngIf="canViewAllDepartments && !isManager && tabDepartments.length > 1">
        <select class="form-select form-select-sm h-100" [(ngModel)]="activeTab" (change)="selectTab(activeTab)">
          <option *ngFor="let dept of tabDepartments" [value]="dept">
            {{ getDepartmentName(dept) }}
          </option>
        </select>
      </div>

      <!-- Date Filter Button -->
      <div class="filter-item position-relative" *ngIf="canFilterByDate">
        <button type="button" class="date-filter-button btn btn-outline-dark btn-sm d-flex align-items-center h-100 w-100"
          (click)="toggleDateFilter($event)">
          <i class="bi bi-calendar3 me-2"></i>
          <span *ngIf="!currentFilterDate">Select Date</span>
          <span *ngIf="currentFilterDate">{{ currentFilterDate | date: 'dd MMM yyyy' }}</span>
          <i class="bi bi-x-circle ms-2 text-danger" *ngIf="currentFilterDate"
            (click)="clearDateFilter(); $event.stopPropagation()"></i>
        </button>

        <!-- Date picker dropdown -->
        <div class="date-picker-dropdown card shadow-sm position-absolute top-100 start-0 mt-1" *ngIf="showDateFilter"
          style="z-index: 1050; width: 320px;" (click)="$event.stopPropagation()">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold mb-0">Select Date</h6>
              <button type="button" class="btn-close" (click)="showDateFilter = false" aria-label="Close"></button>
            </div>

            <form [formGroup]="dateFilterForm" (ngSubmit)="$event.preventDefault(); applyDateFilter()">
              <div class="mb-3">
                <input type="date" class="form-control form-control-sm"
                  [min]="minDate ? (minDate | date: 'yyyy-MM-dd') : ''"
                  [max]="maxDate ? (maxDate | date: 'yyyy-MM-dd') : ''" formControlName="filterDate"
                  (click)="$event.stopPropagation()">
              </div>

              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm flex-grow-1"
                  [disabled]="!dateFilterForm.get('filterDate')?.value || (isManager && !managerDepartmentId)">
                  Apply
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="clearDateFilter()"
                  *ngIf="currentFilterDate">
                  Clear
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Search Input -->
      <div class="search-container ms-md-auto" *ngIf="canSearch">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" class="form-control form-control-sm border-start-0" 
            [placeholder]="getSearchPlaceholder()"
            [(ngModel)]="searchQuery" 
            (input)="onSearchInput($event)"
            [disabled]="isManager && !managerDepartmentId">
          <button class="btn btn-outline-secondary btn-sm" type="button" *ngIf="searchQuery" (click)="clearSearch()">
            <i class="bi bi-x"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 3. ERROR STATES -->
    <div *ngIf="isManager && !managerDepartmentId" 
         class="alert alert-warning mt-3">
      <div class="d-flex align-items-center">
        <i class="bi bi-shield-exclamation fs-4 me-3"></i>
        <div>
          <h6 class="alert-heading mb-1">Department Assignment Required</h6>
          <p class="mb-0">Your manager account is not assigned to any department.</p>
        </div>
      </div>
    </div>

    <!-- 4. FILTER SUMMARY -->
    <div class="filter-summary mb-3" *ngIf="hasAppliedFilters()">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="text-muted small">Applied filters:</span>

        <span class="badge bg-primary" *ngIf="canViewAllBranches && selectedBranchId !== '' && !isManager">
          <span>Branch: {{ getBranchDisplayName() }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="clearBranchFilter()"></i>
        </span>

        <span class="badge bg-info" *ngIf="canViewAllDepartments && !isManager && activeTab !== 'All Employee'">
          <span>Department: {{ activeTab }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="selectTab('All Employee')"></i>
        </span>

        <span class="badge bg-secondary" *ngIf="canSearch && searchQuery.trim() !== ''">
          <span>Search: {{ searchQuery }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="clearSearch()"></i>
        </span>

        <span class="badge bg-warning text-dark" *ngIf="canFilterByDate && currentFilterDate">
          <span>Date: {{ currentFilterDate | date: 'dd MMM yyyy' }}</span>
          <i class="bi bi-x ms-1 cursor-pointer" (click)="clearDateFilter()"></i>
        </span>

        <button class="btn btn-outline-danger btn-sm ms-2" (click)="clearAllFilters()">
          Clear All Filters
        </button>
      </div>
    </div>

    <!-- 5. MAIN TABLE -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>Emp Code</th>
            <th>Employee</th>
            <th>Department</th>
            <th>Date</th>
            <!-- <th>Status</th> -->
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Late Check-In</th>
            <th>Total Work Hours</th>
            <th>Over Time</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let emp of paginatedData; trackBy: trackByEmployee" [ngClass]="getRowClass(emp)">
            <td>{{ emp.empCode || '--' }}</td>
             <td>{{ getEmployeeFullName(emp) }}</td>
            <td>{{ getDepartmentDisplayName(emp) }}</td>
            <td>{{ emp.attendanceDate ? formatDateForDisplay(emp.attendanceDate) : '--' }}</td>
            <!-- <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(emp.status || '')">
                {{ emp.status || '--' }}
              </span>
            </td> -->
            <td>{{ formatTime(emp.actualCheckInTime) || '--' }}</td>
            <td>{{ formatTime(emp.actualCheckOutTime) || '--' }}</td>
            <td>{{ formatTime(emp.lateCheckInTime) || '--' }}</td>
            <td>{{ formatTime(emp.totalDuration) || '--' }}</td>
            <td>{{ formatTime(emp.overTime) || '--' }}</td>
          </tr>
          
          <tr *ngIf="!isLoading && attendanceData?.length === 0">
            <td colspan="9" class="text-center py-5">
              <div>
                <i class="bi bi-people display-4 d-block mb-3 text-muted"></i>
                <p class="mb-2 text-muted">{{ emptyStateMessage }}</p>
                <button *ngIf="hasAppliedFilters()" class="btn btn-outline-primary btn-sm" (click)="clearAllFilters()">
                  Clear Filters
                </button>
              </div>
            </td>
          </tr>
          
          <tr *ngIf="isLoading">
            <td colspan="9" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 6. PAGINATION -->
    <div class="card-footer bg-light border-0" *ngIf="paginatedData.length > 0">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="dataTables_info text-muted small">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
            {{ Math.min(currentPage * itemsPerPage, filteredAttendance.length) }} of 
            {{ filteredAttendance.length }} entries
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="itemsPerPage"
              (change)="onItemsPerPageChange()">
              <option [value]="5">5 per page</option>
              <option [value]="10">10 per page</option>
              <option [value]="25">25 per page</option>
              <option [value]="50">50 per page</option>
            </select>

            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="goToFirstPage()" [disabled]="currentPage === 1">
                    <i class="bi bi-chevron-double-left"></i>
                  </button>
                </li>
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                </li>

                <li class="page-item active" *ngIf="totalPages > 0">
                  <span class="page-link">{{ currentPage }} of {{ totalPages }}</span>
                </li>

                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link" (click)="goToLastPage()" [disabled]="currentPage === totalPages">
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>