<div class="att-det-container container-fluid">
  <!-- ========== HEADER SECTION ========== -->
  <div class="att-det-header d-flex justify-content-between align-items-start mb-4">
    <div>
      <h2 class="att-det-title">
        {{ currentUserRole === 'EMPLOYEE' ? 'My Attendance' : 'Employee Attendance' }}
      </h2>
      <p class="att-det-subtitle text-muted mb-0">
        {{ currentUserRole === 'EMPLOYEE' ?
           'Track your attendance records and work hours.' :
           'Keep track of employee attendance on a daily basis.' }}
      </p>
      <!-- Show employee ID for employees -->
      <small class="text-muted" *ngIf="currentUserRole === 'EMPLOYEE' && currentUserEmpId">
        Employee ID: {{ currentUserEmpId }}
      </small>
    </div>

    <!-- Action Buttons -->
    <div class="att-det-actions d-flex gap-2 align-items-start">
      <button *ngIf="canExport"
              class="att-det-export-btn btn btn-warning d-flex align-items-center"
              (click)="exportToPdf()">
        <i class="bi bi-download me-2"></i>
        Export
      </button>
    </div>
  </div>

  <!-- Divider -->
  <div class="att-det-divider w-100 pb-3 mb-4" style="border-bottom: 1px solid #dee2e6;"></div>

  <!-- Filter Container -->
  <div class="filter-container d-flex flex-wrap align-items-stretch gap-2 mb-4">
    <!-- Branch Select - Only show for roles with permission -->
    <div class="filter-item" *ngIf="canViewAllBranches">
      <select class="form-select form-select-sm h-100"
              [(ngModel)]="selectedBranchId"
              (change)="onBranchChange($event)">
        <option value="">All Branches</option>
        <option *ngFor="let branch of branches" [value]="branch.branchId">
          {{ branch.branchName }}
        </option>
      </select>
    </div>

    <!-- Department Select - Only show for roles with permission -->
    <div class="filter-item" *ngIf="canViewAllDepartments">
      <select class="form-select form-select-sm h-100"
              [(ngModel)]="activeTab"
              (change)="selectTab(activeTab)">
        <option *ngFor="let dept of tabDepartments" [value]="dept">
          {{ getDepartmentName(dept) }}
        </option>
      </select>
    </div>

    <!-- Status Filter - Show for all roles with permission -->
    <div class="filter-item" *ngIf="canFilterByStatus">
      <select class="form-select form-select-sm h-100"
              [(ngModel)]="selectedStatus"
              (change)="setStatusFilter(selectedStatus)">
        <option *ngFor="let status of statuses" [value]="status">
          {{ status }}
        </option>
      </select>
    </div>

    <!-- Date Filter Button - Show for all roles with permission -->
    <div class="filter-item position-relative" *ngIf="canFilterByDate">
      <button type="button"
              class="date-filter-button btn btn-outline-dark btn-sm d-flex align-items-center h-100 w-100"
              (click)="toggleDateFilter($event)">
        <i class="bi bi-calendar3 me-2"></i>
        <span *ngIf="!currentFilterDate">Select Date</span>
        <span *ngIf="currentFilterDate">{{ currentFilterDate | date: 'dd MMM yyyy' }}</span>
        <i class="bi bi-x-circle ms-2 text-danger"
           *ngIf="currentFilterDate"
           (click)="clearDateFilter(); $event.stopPropagation()"></i>
      </button>

      <!-- Date filter dropdown -->
      <div class="date-picker-dropdown card shadow-sm position-absolute top-100 start-0 mt-1"
           *ngIf="showDateFilter"
           style="z-index: 1050; width: 300px;"
           (click)="$event.stopPropagation()">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0">Select Date</h6>
            <button type="button" class="btn-close" (click)="showDateFilter = false" aria-label="Close"></button>
          </div>

          <form [formGroup]="dateFilterForm" (ngSubmit)="$event.preventDefault(); applyDateFilter()">
            <div class="mb-3">
              <input type="date"
                     class="form-control form-control-sm"
                     [min]="minDate | date: 'yyyy-MM-dd'"
                     [max]="maxDate | date: 'yyyy-MM-dd'"
                     formControlName="filterDate"
                     (click)="$event.stopPropagation()">
            </div>

            <div class="d-flex gap-2">
              <button type="submit"
                      class="btn btn-primary btn-sm flex-grow-1"
                      [disabled]="!dateFilterForm.get('filterDate')?.value">
                Apply
              </button>
              <button type="button"
                      class="btn btn-outline-secondary btn-sm"
                      (click)="clearDateFilter()"
                      *ngIf="currentFilterDate">
                Clear
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Search Input - Only show for roles with permission -->
    <div class="search-container ms-md-auto" *ngIf="canSearch">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text"
               class="form-control form-control-sm border-start-0"
               placeholder="Search by name or id..."
               [(ngModel)]="searchQuery"
               (input)="onSearchInput($event)">
        <button class="btn btn-outline-secondary btn-sm"
                type="button"
                *ngIf="searchQuery"
                (click)="clearSearch()">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Summary -->
  <div class="filter-summary mb-3" *ngIf="hasAppliedFilters()">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="text-muted small">Applied filters (in sequence):</span>

      <span class="badge bg-primary"
            *ngIf="canViewAllBranches && selectedBranchId !== ''"
            style="order: 1;">
        <span>1. Branch: {{ getBranchDisplayName() }}</span>
        <i class="bi bi-x ms-1 cursor-pointer" (click)="clearBranchFilter()"></i>
      </span>

      <span class="badge bg-info"
            *ngIf="canViewAllDepartments && activeTab !== 'All Employee'"
            style="order: 2;">
        <span>2. Department: {{ activeTab }}</span>
        <i class="bi bi-x ms-1 cursor-pointer" (click)="selectTab('All Employee')"></i>
      </span>

      <span class="badge bg-warning"
            *ngIf="canFilterByStatus && selectedStatus !== 'All Employee'"
            style="order: 3;">
        <span>{{ currentUserRole === 'EMPLOYEE' ? '1' : '3' }}. Status: {{ selectedStatus }}</span>
        <i class="bi bi-x ms-1 cursor-pointer" (click)="setStatusFilter('All Employee')"></i>
      </span>

      <span class="badge bg-secondary"
            *ngIf="canSearch && searchQuery.trim() !== ''"
            style="order: 4;">
        <span>4. Search: {{ searchQuery }}</span>
        <i class="bi bi-x ms-1 cursor-pointer" (click)="clearSearch()"></i>
      </span>

      <span class="badge bg-success"
            *ngIf="canFilterByDate && currentFilterDate"
            style="order: 5;">
        <span>{{ currentUserRole === 'EMPLOYEE' ? '2' : '5' }}. Date: {{ currentFilterDate | date: 'dd MMM yyyy' }}</span>
        <i class="bi bi-x ms-1 cursor-pointer" (click)="clearDateFilter()"></i>
      </span>

      <button class="btn btn-outline-danger btn-sm ms-2"
              (click)="clearAllFilters()">
        Clear All Filters
      </button>
    </div>

    <!-- Filter Results Info -->
    <div class="mt-2" *ngIf="!isLoading">
      <small class="text-muted">
        <i class="bi bi-info-circle me-1"></i>
        <span *ngIf="filteredAttendance.length > 0">
          Found {{ filteredAttendance.length }}
          {{ currentUserRole === 'EMPLOYEE' ? 'record(s)' : 'employee(s)' }}
          matching your filter criteria
        </span>
        <span *ngIf="filteredAttendance.length === 0" class="text-warning">
          No {{ currentUserRole === 'EMPLOYEE' ? 'records' : 'employees' }} found with the current filter combination
        </span>
      </small>
    </div>
  </div>

  <!-- Loading State -->
  <div class="d-flex justify-content-center align-items-center py-5" *ngIf="isLoading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <span class="ms-3">Loading attendance data...</span>
  </div>

  <!-- Attendance Table -->
  <div class="card border-0 shadow-sm" *ngIf="!isLoading">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <!-- Only show Emp ID column for non-employee roles -->
            <th class="py-2" *ngIf="currentUserRole !== 'EMPLOYEE'">Emp ID</th>
            <!-- Only show Employee column for non-employee roles -->
            <th class="py-2" *ngIf="currentUserRole !== 'EMPLOYEE'">Employee</th>
            <th class="py-2">Date</th>
            <th class="py-2">Shift</th>
            <th class="py-2">Status</th>
            <th class="py-2">Clock In</th>
            <th class="py-2">Clock Out</th>
            <th class="py-2">Late Check-In</th>
            <th class="py-2">Over Time</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngIf="paginatedData.length > 0; else noData">
            <tr *ngFor="let emp of paginatedData" class="att-det-table-row border-bottom">
              <!-- Only show Emp ID for non-employee roles -->
              <td class="py-2 align-middle" *ngIf="currentUserRole !== 'EMPLOYEE'">
                <span class="text-nowrap">{{ emp.empCode || '--' }}</span>
              </td>
              <!-- Only show Employee info for non-employee roles -->
              <td class="py-2 align-middle" *ngIf="currentUserRole !== 'EMPLOYEE'">
                <div class="d-flex align-items-center">
                  <div>
                    <div class="fw-medium text-nowrap">{{ getEmployeeFullName(emp) || '--' }}</div>
                    <small class="text-muted">{{ getDepartmentDisplayName(emp) }}</small>
                  </div>
                </div>
              </td>
              <td class="py-2 align-middle">
                <span class="text-nowrap">{{ formatDate(emp.attendanceDate) || '--' }}</span>
              </td>
              <td class="py-2 align-middle">
                <span class="badge bg-warning bg-opacity-10 text-warning text-nowrap">
                  {{ emp.timePeriod || '--' }}
                </span>
              </td>
              <td class="py-2 align-middle">
                <span class="badge d-inline-flex align-items-center" [ngClass]="{
                  'bg-success bg-opacity-10 text-success': emp.status === 'Present',
                  'bg-danger bg-opacity-10 text-danger': emp.status === 'Absent',
                  'bg-warning bg-opacity-10 text-warning': emp.status === 'Late',
                  'bg-info bg-opacity-10 text-info': emp.status === 'Early Departure',
                  'bg-secondary bg-opacity-10 text-secondary': !emp.status
                }">
                  {{ emp.status || '--' }}
                </span>
              </td>
              <td class="py-2 align-middle">
                <span class="text-nowrap">{{ emp.actualCheckInTime || '--' }}</span>
              </td>
              <td class="py-2 align-middle">
                <span class="text-nowrap">{{ emp.actualCheckOutTime || '--' }}</span>
              </td>
              <td class="py-2 align-middle">
                <span *ngIf="emp.lateCheckInTime && emp.lateCheckInTime !== '00:00' && emp.lateCheckInTime !== '--'"
                      class="d-inline-flex align-items-center text-danger">
                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                  <span class="text-nowrap">{{ emp.lateCheckInTime }}</span>
                </span>
                <span *ngIf="!emp.lateCheckInTime || emp.lateCheckInTime === '00:00' || emp.lateCheckInTime === '--'"
                      class="text-muted">--</span>
              </td>
              <td class="py-2 align-middle">
                <span class="text-nowrap">{{ emp.overTime || '--' }}</span>
              </td>
            </tr>
          </ng-container>

          <ng-template #noData>
            <tr>
              <td [attr.colspan]="currentUserRole === 'EMPLOYEE' ? 7 : 9"
                  class="att-det-empty text-center py-5">
                <div>
                  <i class="bi bi-people display-4 d-block mb-3 text-muted"></i>
                  <p class="mb-2 text-muted">{{ emptyStateMessage }}</p>
                  <div *ngIf="hasAppliedFilters()">
                    <button class="btn btn-outline-primary btn-sm"
                            (click)="clearAllFilters()">
                      Clear All Filters
                    </button>
                  </div>
                </div>
              </td>
            </tr>
          </ng-template>
        </tbody>
      </table>
    </div>

    <!-- Pagination Footer -->
    <div class="card-footer bg-light border-0" *ngIf="paginatedData.length > 0">
      <div class="row align-items-center">
        <div class="col-md-6">
          <div class="dataTables_info text-muted small">
            <span>
              Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to
              {{ Math.min(currentPage * itemsPerPage, filteredAttendance.length) }} of
              {{ filteredAttendance.length }} entries
            </span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <select class="form-select form-select-sm"
                    style="width: auto;"
                    [(ngModel)]="itemsPerPage"
                    (change)="onItemsPerPageChange()">
              <option [value]="5">5 per page</option>
              <option [value]="10">10 per page</option>
              <option [value]="25">25 per page</option>
              <option [value]="50">50 per page</option>
            </select>

            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="goToFirstPage()" [disabled]="currentPage === 1">
                    <i class="bi bi-chevron-double-left"></i>
                  </button>
                </li>
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                </li>

                <li class="page-item active" *ngIf="totalPages > 0">
                  <span class="page-link">{{ currentPage }} of {{ totalPages }}</span>
                </li>

                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link" (click)="nextPage()" [disabled]="currentPage === totalPages">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                  <button class="page-link" (click)="goToLastPage()" [disabled]="currentPage === totalPages">
                    <i class="bi bi-chevron-double-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="errorMessage && !isLoading" class="alert alert-danger mt-3">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <span>{{ errorMessage }}</span>
    <button class="btn btn-outline-danger btn-sm ms-3" (click)="loadAttendanceData()">
      Try Again
    </button>
  </div>
</div>
