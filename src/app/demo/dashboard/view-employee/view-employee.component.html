<div class="attendance-container">
  <div class="attendance-container">
    <!-- Filter Controls -->
    <div class="filter-controls">
      <div class="filters-container">
        <h4 class="page-title">
          {{ isViewAll ? (isManager ? managerDepartmentName + ' Department Employees Details' : 'All Employees Attendance Details') : 
             (isEmployeeRole() ? 'My Attendance Details' : 'Employee Attendance Details') }}
        </h4>

        <div class="filters-and-actions">
          <div class="filter-section">
            <!-- Year Filter for Admin/HR -->
            <div class="filter-group" *ngIf="canViewAllEmployeesCheck() && !isManager">
              <label for="yearFilter">Year:</label>
              <select id="yearFilter" [(ngModel)]="selectedYear" (change)="onFilterChange()">
                <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
              </select>
            </div>

            <!-- Month Filter for Admin/HR -->
            <div class="filter-group" *ngIf="canViewAllEmployeesCheck() && !isManager">
              <label for="monthFilter">Month:</label>
              <select id="monthFilter" [(ngModel)]="selectedMonth" (change)="onFilterChange()">
                <option *ngFor="let month of availableMonths" [value]="month.value">{{ month.name }}</option>
              </select>
            </div>

            <!-- Department Filter for Admin/HR -->
            <div class="filter-group" *ngIf="isViewAll && canViewAllEmployeesCheck() && !isManager">
              <label for="deptFilter">Department:</label>
              <select id="deptFilter" [(ngModel)]="selectedDepartment" (change)="onFilterChange()">
                <option *ngFor="let dept of availableDepartments" [value]="dept === 'All' ? 'All' : dept">
                  {{ dept }}
                </option>
              </select>
            </div>

            <!-- Year Filter for Managers -->
            <div class="filter-group" *ngIf="isManager && managerDepartmentId">
              <label for="yearFilterManager">Year:</label>
              <select id="yearFilterManager" [(ngModel)]="selectedYear" (change)="onFilterChange()">
                <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
              </select>
            </div>

            <!-- Month Filter for Managers -->
            <div class="filter-group" *ngIf="isManager && managerDepartmentId">
              <label for="monthFilterManager">Month:</label>
              <select id="monthFilterManager" [(ngModel)]="selectedMonth" (change)="onFilterChange()">
                <option *ngFor="let month of availableMonths" [value]="month.value">{{ month.name }}</option>
              </select>
            </div>

            <!-- Manager Department Display (Read-only) -->
            <div class="filter-group" *ngIf="isManager && managerDepartmentId">
              <div class="manager-dept-display form-control form-control-sm h-100 d-flex align-items-center bg-success bg-opacity-10">
                <i class="bi bi-building me-2 text-success"></i>
                <span class="fw-medium text-dark">{{ managerDepartmentName || 'Loading...' }}</span>
                <small class="text-muted ms-2">(Your Department)</small>
              </div>
            </div>

            <!-- Year Filter for Employees -->
            <div class="filter-group" *ngIf="isEmployeeRole()">
              <label for="yearFilterEmployee">Year:</label>
              <select id="yearFilterEmployee" [(ngModel)]="selectedYear" (change)="onFilterChange()">
                <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
              </select>
            </div>

            <!-- Month Filter for Employees -->
            <div class="filter-group" *ngIf="isEmployeeRole()">
              <label for="monthFilterEmployee">Month:</label>
              <select id="monthFilterEmployee" [(ngModel)]="selectedMonth" (change)="onFilterChange()">
                <option *ngFor="let month of availableMonths" [value]="month.value">{{ month.name }}</option>
              </select>
            </div>

            <!-- Employee Name Display -->
            <div class="filter-group" *ngIf="isEmployeeRole() && currentUserName">
              <div class="employee-name-display form-control form-control-sm h-100 d-flex align-items-center bg-light">
                <i class="bi bi-person-circle me-2 text-primary"></i>
                <span class="fw-medium text-dark">{{ currentUserName }}</span>
              </div>
            </div>

            <!-- Reset Button -->
            <button class="reset-btn" (click)="resetFilters()" title="Reset Filters" *ngIf="canViewAllEmployeesCheck() || isEmployeeRole()">
              <i class="ti ti-refresh"></i>
            </button>

            <!-- Back Button -->
            <button class="back-btn" (click)="goBack()" title="Go Back">
              <i class="ti ti-arrow-left"></i>
            </button>

            <!-- Export Button -->
            <button (click)="exportToExcel()" class="action-btn btn btn-primary" title="Export to CSV" *ngIf="canExport">
              <i class="bi bi-download"></i> Export 
            </button>
          </div>
        </div>
      </div>

      <!-- Current Data Info -->
      <div class="data-info" *ngIf="!isLoading && employees.length > 0">
        <small class="text-muted">
          Showing data for: <strong>{{ currentMonthName }} {{ selectedYear }}</strong>
          <span *ngIf="selectedDepartment !== 'All' && !isManager"> | Department: <strong>{{ selectedDepartment }}</strong></span>
          <span *ngIf="isManager && managerDepartmentName"> | Department: <strong>{{ managerDepartmentName }}</strong></span>
          <span *ngIf="isEmployeeRole()"> | Employee: <strong>{{ getCurrentEmployeeName() }}</strong></span>
        </small>
      </div>
    </div>

    <!-- Manager Access Warning -->
    <div class="alert alert-warning alert-sm mt-2" *ngIf="isManager && !managerDepartmentId">
      <i class="bi bi-exclamation-triangle me-1"></i>
      Access restricted: No department assigned to your manager account.
    </div>

    <!-- Manager Department Confirmation -->
    <div class="alert alert-info alert-sm mt-2" *ngIf="isManager && managerDepartmentId">
      <i class="bi bi-check-circle me-1"></i>
      Department access confirmed: {{ managerDepartmentName || 'Loading department...' }}
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner"></div>
      <p>Loading attendance data...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading" class="error-message">
      <i class="ti ti-alert-circle"></i>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Main Attendance Table -->
    <div class="main-attendance-section" *ngIf="!isLoading && !errorMessage && employees.length > 0">
      <div class="attendance-table-wrapper">
        <table class="main-attendance-table">
          <!-- Separate Headers - Week and Date in different rows -->
          <thead>
            <tr class="week-header">
              <th class="row-label-header"></th>
              <th *ngFor="let day of dynamicWeekHeaders; let i = index" class="day-header"
                [class.weekend]="day === 'Sat' || day === 'Sun'">
                {{ day }}
              </th>
            </tr>
            <tr class="date-header">
              <th class="row-label-header"></th>
              <th *ngFor="let date of dynamicDateHeaders; let i = index" class="date-cell"
                [class.weekend]="dynamicWeekHeaders[i] === 'Sat' || dynamicWeekHeaders[i] === 'Sun'">
                {{ date }}
              </th>
            </tr>
          </thead>

          <!-- Employee Data Sections -->
          <tbody>
            <!-- Show employee data if available -->
            <ng-container *ngIf="employees.length > 0">
              <ng-container *ngFor="let person of paginatedEmployees; let personIndex = index">
                <!-- Employee Name and Designation -->
                <tr class="employee-name-row">
                  <td [attr.colspan]="dynamicDateHeaders.length + 1" class="employee-info">
                    <strong>{{ person.name }}</strong> &nbsp;&nbsp; 
                    <span *ngIf="person.designation">Department: <strong>{{ person.designation }}</strong></span>
                    <span *ngIf="!person.designation">Department: <strong>Not specified</strong></span>
                  </td>
                </tr>

                <!-- Dashed separator line -->
                <tr class="separator-row">
                  <td [attr.colspan]="dynamicDateHeaders.length + 1" class="dashed-separator"></td>
                </tr>

                <!-- Shift Row -->
                <tr class="data-row">
                  <td class="row-label">Shift</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.shift || '--' }}
                  </td>
                </tr>

                <!-- Status Row -->
                <tr class="data-row">
                  <td class="row-label">Day Status</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index"
                    class="data-cell {{ getStatusClass(person.records[i]?.dayStatus) }}">
                    {{ person.records[i]?.dayStatus || '--' }}
                  </td>
                </tr>

                <!-- Check-in Row -->
                <tr class="data-row">
                  <td class="row-label">Check - in</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.checkIn || '--' }}
                  </td>
                </tr>

                <!-- Check-out Row -->
                <tr class="data-row">
                  <td class="row-label">Check - out</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.checkOut || '--' }}
                  </td>
                </tr>

                <!-- Break Time Row -->
                <tr class="data-row">
                  <td class="row-label">Break Time</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.breakTime || '--' }}
                  </td>
                </tr>

                <!-- Working Hours Row -->
                <tr class="data-row">
                  <td class="row-label">Working Hours</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.workingHours || '--' }}
                  </td>
                </tr>

                <!-- Extra Hours Row -->
                <tr class="data-row">
                  <td class="row-label">Extra Hours</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.extraHours || '--' }}
                  </td>
                </tr>

                <!-- Late Time Row -->
                <tr class="data-row">
                  <td class="row-label">Late Time</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.lateTime || '--' }}
                  </td>
                </tr>

                <!-- Early Time Row -->
                <tr class="data-row">
                  <td class="row-label">Early Time</td>
                  <td *ngFor="let date of dynamicDateHeaders; let i = index" class="data-cell">
                    {{ person.records[i]?.earlyTime || '--' }}
                  </td>
                </tr>

                <!-- Space between employees -->
                <tr class="employee-spacer" *ngIf="personIndex < paginatedEmployees.length - 1">
                  <td [attr.colspan]="dynamicDateHeaders.length + 1"></td>
                </tr>
              </ng-container>
            </ng-container>
          </tbody>
        </table>
        
        <!-- Pagination Controls -->
        <div class="pagination-controls" *ngIf="totalItems > itemsPerPage">
          <button 
            class="page-button" 
            [disabled]="currentPage === 1"
            (click)="onPageChange(1)">
            &laquo;
          </button>
          <button 
            class="page-button" 
            [disabled]="currentPage === 1"
            (click)="onPageChange(currentPage - 1)">
            &lsaquo;
          </button>
          
          <ng-container *ngFor="let page of pageNumbers">
            <button 
              class="page-button" 
              [class.active]="page === currentPage"
              (click)="onPageChange(page)">
              {{ page }}
            </button>
          </ng-container>
          
          <button 
            class="page-button" 
            [disabled]="currentPage === totalPages"
            (click)="onPageChange(currentPage + 1)">
            &rsaquo;
          </button>
          <button 
            class="page-button" 
            [disabled]="currentPage === totalPages"
            (click)="onPageChange(totalPages)">
            &raquo;
          </button>
          
          <span class="page-info">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} - 
            {{ currentPage * itemsPerPage > totalItems ? totalItems : currentPage * itemsPerPage }} 
            of {{ totalItems }} entries
          </span>
        </div>
      </div>
    </div>

    <!-- No Data State -->
    <div *ngIf="!isLoading && !errorMessage && employees.length === 0" class="no-data-message">
      <i class="ti ti-info-circle"></i>
      <span>{{ getNoDataMessage() }}</span>
    </div>
  </div>
</div>