
<div class="rbac-dashboard">
  <header class="dashboard-header">
    <div class="header-actions">
      <h1 class="dashboard-title">Permission Management</h1>

      <div *ngIf="userId" class="action-buttons">
        <button class="edit-button" (click)="toggleEditMode()" *ngIf="!isEditMode">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>
          </svg>
          Edit Permissions
        </button>
        <div *ngIf="isEditMode" class="edit-mode-actions">
          <button class="save-button" (click)="savePermissions()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15C9 16.66 10.34 18 12 18C13.66 18 15 16.66 15 15C15 13.34 13.66 12 12 12ZM6 6H15V10H6V6Z" fill="currentColor"/>
            </svg>
            Save Changes
          </button>
          <button class="cancel-button" (click)="toggleEditMode()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
            </svg>
            Cancel
          </button>
        </div>
      </div>
    </div>
  </header>

  <div *ngIf="isNewUser && !isEditMode" class="new-user-indicator">
    <span class="indicator-icon">ðŸ‘¤</span>
    <span>This user has no permissions set up yet.</span>
    <button class="setup-button" (click)="toggleEditMode()">Set Up Permissions</button>
  </div>
  
  <!-- Permission Controls -->
  <div *ngIf="isEditMode" class="permission-controls">
    <div class="control-row">
      <div class="control-group">
        <label for="permissionType">Permission Type</label>
        <select id="permissionType" [(ngModel)]="permissionType" class="form-control" (change)="onPermissionTypeChange()">
          <option value="GRANT">Grant</option>
          <option value="TEMPORARY">Temporary</option>
        </select>
      </div>

      <div class="control-group">
        <label>Selected Menu(s)</label>
        <div class="selected-menu-display" [class.multi-module]="isMultiModuleSelection && selectedMenuIds.length > 1">
          {{ getSelectedMenusDisplay() }}
          <span *ngIf="isMultiModuleSelection && selectedMenuIds.length > 3" 
                class="tooltip-trigger" 
                [title]="getMenuNames(selectedMenuIds)">
            
          </span>
        </div>
        <div *ngIf="isMultiModuleSelection && selectedMenuIds.length > 0" class="selected-count">
          Total modules selected: {{ selectedMenuIds.length }}
        </div>
      </div>

      <div class="control-group" *ngIf="showExpiryDate">
        <label for="expiryDate">Expiry Date *</label>
        <input type="date" id="expiryDate" [(ngModel)]="expiryDate" class="form-control date-picker" 
               [min]="minDate" [required]="permissionType === 'TEMPORARY'">
        <div *ngIf="permissionType === 'TEMPORARY' && !expiryDate" class="text-danger small">
          Expiry date is required
        </div>
      </div>

      <div class="control-group" *ngIf="showExpiryDate">
        <label for="expiryTime">Expiry Time *</label>
        <input type="time" id="expiryTime" [(ngModel)]="expiryTime" class="form-control time-picker"
               [required]="permissionType === 'TEMPORARY'">
        <div *ngIf="permissionType === 'TEMPORARY' && !expiryTime" class="text-danger small">
          Expiry time is required
        </div>
      </div>

      <div class="control-group">
        <label for="isActive">Status</label>
        <select id="isActive" [(ngModel)]="isActive" class="form-control">
          <option [ngValue]="true">Active</option>
          <option [ngValue]="false">Inactive</option>
        </select>
      </div>
    </div>
  </div>

  <main class="permission-container">
    <div *ngIf="loading()" class="loading-message">Loading permissions...</div>
    <div *ngIf="error()" class="error-message">{{error()}}</div>

    <div class="permission-group" *ngFor="let group of permissionGroups()">
      <div class="group-header" (click)="toggleGroup(group.id); selectedMenuId = group.id">
        <div class="group-title-container">
          <span class="group-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/>
              <path d="M12 7C11.45 7 11 7.45 11 8V12C11 12.55 11.45 13 12 13H16C16.55 13 17 12.55 17 12C17 11.45 16.55 11 16 11H13V8C13 7.45 12.55 7 12 7Z" fill="currentColor"/>
            </svg>
          </span>
          <h2 class="group-title">{{ group.name }}</h2>
        </div>
        <span class="toggle-icon">{{ group.expanded ? 'âˆ’' : '+' }}</span>
      </div>

      <div class="group-content" *ngIf="group.expanded">
        <div class="sub-group" *ngIf="group.subGroups">
          <div class="sub-group-item" *ngFor="let subGroup of group.subGroups">
            <div class="sub-group-header" (click)="selectedMenuId = subGroup.id">
              <h3 class="sub-group-title">{{ subGroup.name }}</h3>
            </div>
          </div>
        </div>

        <div class="group-permissions">
          <div class="group-permissions-header">
            <h3>{{ group.subGroups?.length ? 'Apply to all submodules:' : 'Module Permissions:' }}</h3>
          </div>
          <div class="group-permission-options">
            <label class="permission-option">
              <input type="checkbox" 
                [checked]="isPermissionCheckedForAllSubmodules(group.id, 'view')"
                [indeterminate]="isPermissionIndeterminate(group.id, 'view')"
                (change)="isEditMode && togglePermissionForAllSubmodules(group.id, 'view', $event.target.checked)"
                [disabled]="!isEditMode">
              <span class="option-label" [class.disabled]="!isEditMode">View</span>
            </label>
            
            <label class="permission-option">
              <input type="checkbox" 
                [checked]="isPermissionCheckedForAllSubmodules(group.id, 'create')"
                [indeterminate]="isPermissionIndeterminate(group.id, 'create')"
                (change)="isEditMode && togglePermissionForAllSubmodules(group.id, 'create', $event.target.checked)"
                [disabled]="!isEditMode">
              <span class="option-label" [class.disabled]="!isEditMode">Create</span>
            </label>
            
            <label class="permission-option">
              <input type="checkbox" 
                [checked]="isPermissionCheckedForAllSubmodules(group.id, 'update')"
                [indeterminate]="isPermissionIndeterminate(group.id, 'update')"
                (change)="isEditMode && togglePermissionForAllSubmodules(group.id, 'update', $event.target.checked)"
                [disabled]="!isEditMode">
              <span class="option-label" [class.disabled]="!isEditMode">Update</span>
            </label>
            
            <label class="permission-option">
              <input type="checkbox" 
                [checked]="isPermissionCheckedForAllSubmodules(group.id, 'delete')"
                [indeterminate]="isPermissionIndeterminate(group.id, 'delete')"
                (change)="isEditMode && togglePermissionForAllSubmodules(group.id, 'delete', $event.target.checked)"
                [disabled]="!isEditMode">
              <span class="option-label" [class.disabled]="!isEditMode">Delete</span>
            </label>
            
            <label class="permission-option">
              <input type="checkbox" 
                [checked]="isPermissionCheckedForAllSubmodules(group.id, 'export')"
                [indeterminate]="isPermissionIndeterminate(group.id, 'export')"
                (change)="isEditMode && togglePermissionForAllSubmodules(group.id, 'export', $event.target.checked)"
                [disabled]="!isEditMode">
              <span class="option-label" [class.disabled]="!isEditMode">Export</span>
            </label>
            
            <label class="permission-option" *ngIf="hasSubgroupWithApprove(group)">
              <input type="checkbox" 
                [checked]="isPermissionCheckedForAllSubmodules(group.id, 'approve')"
                [indeterminate]="isPermissionIndeterminate(group.id, 'approve')"
                (change)="isEditMode && togglePermissionForAllSubmodules(group.id, 'approve', $event.target.checked)"
                [disabled]="!isEditMode">
              <span class="option-label" [class.disabled]="!isEditMode">Approve</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>